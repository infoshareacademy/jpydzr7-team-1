<!DOCTYPE html>
{% load static %}
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>{% block title %}Budżet - historia transakcji {% endblock %}</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Bootstrap Datepicker CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css"
          rel="stylesheet">
    <!-- Custom CSS -->
    <link href="{% static 'css/styles.css' %}" rel="stylesheet">
    <style>
        .switch-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .form-switch .form-check-input {
            width: 2.5em;
            height: 1.25em;
        }
        .switch-label {
            font-size: 0.9rem;
            font-weight: 500;
        }
        .switch-wrapper {
            position: relative;
        }

        /* Mobile optimizations */
        @media (max-width: 767.98px) {
            /* Mobile sidebar - hidden by default */
            .sidebar {
                position: fixed;
                top: 0;
                left: -100%;
                height: 100vh;
                width: 280px;
                z-index: 1050;
                transition: left 0.3s ease-in-out;
                overflow-y: auto;
            }

            .sidebar.show {
                left: 0;
            }

            /* Overlay for mobile sidebar */
            .sidebar-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
                z-index: 1040;
                display: none;
            }

            .sidebar-overlay.show {
                display: block;
            }

            /* Main content adjustments for mobile */
            .main-content {
                width: 100%;
                margin-left: 0;
            }

            /* Mobile header adjustments */
            .mobile-header {
                padding: 0.75rem 1rem;
            }

            .mobile-header h2 {
                font-size: 1.25rem;
                margin-bottom: 0.5rem;
            }

            /* Mobile switch container */
            .switch-container {
                flex-direction: column;
                gap: 8px;
                align-items: center;
            }

            .switch-label {
                font-size: 0.8rem;
            }

            /* Mobile menu button */
            .mobile-menu-btn {
                position: fixed;
                top: 1rem;
                left: 1rem;
                z-index: 1060;
                background: var(--bs-primary);
                border: none;
                border-radius: 50%;
                width: 45px;
                height: 45px;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            }

            /* Mobile content padding */
            .mobile-content {
                padding: 60px 1rem 1rem 1rem;
            }

            /* Form adjustments for mobile */
            .sidebar form {
                padding: 0 0.5rem;
            }

            .sidebar .form-select-sm,
            .sidebar .form-control-sm {
                font-size: 0.875rem;
            }

            /* Date picker adjustments */
            .date-input-group {
                position: relative;
            }

            .calendar-icon {
                position: absolute;
                right: 10px;
                top: 50%;
                transform: translateY(-50%);
                cursor: pointer;
                z-index: 10;
            }
        }

        /* Tablet adjustments */
        @media (min-width: 768px) and (max-width: 991.98px) {
            .sidebar {
                width: 240px;
            }

            .switch-container {
                gap: 8px;
            }

            .switch-label {
                font-size: 0.85rem;
            }
        }

        /* Desktop - original layout */
        @media (min-width: 992px) {
            .mobile-menu-btn {
                display: none;
            }

            .sidebar {
                position: sticky;
                top: 0;
                height: 100vh;
            }
        }
    </style>
    {% block extra_styles %}{% endblock %}
</head>
<body>
{% include 'navbar.html' %}

<!-- Mobile menu button -->
<button class="mobile-menu-btn d-lg-none" type="button" onclick="toggleMobileSidebar()">
    <i class="bi bi-list text-white fs-5"></i>
</button>

<!-- Sidebar overlay for mobile -->
<div class="sidebar-overlay" onclick="closeMobileSidebar()"></div>

<div class="container-fluid p-0">
    <div class="row g-0">
        <!-- Sidebar (boczne menu) -->
        <div class="col-lg-2 sidebar sticky-sidebar text-white p-3" id="sidebar">
            <!-- Close button for mobile -->
            <div class="d-flex justify-content-between align-items-center d-lg-none mb-3">
                <h4 class="fw-bold mb-0">Menu</h4>
                <button class="btn btn-sm btn-outline-light" onclick="closeMobileSidebar()">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>

            <h4 class="fw-bold pb-2 border-bottom border-secondary mb-3 d-none d-lg-block">Transakcje</h4>
            <ul class="nav flex-column mb-4">
                <li class="nav-item">
                    <a class="nav-link text-white py-2 rounded {% block menu_all %}{% endblock %}" href="#"
                       id="all-transactions-link"
                       onclick="navigateToAllTransactions()">
                        <i class="bi bi-arrow-left-right me-2"></i>Wszystkie
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-white py-2 rounded {% block menu_expenses %}{% endblock %}" href="#"
                       id="expenses-link"
                       onclick="navigateToExpenses()">
                        <i class="bi bi-arrow-left-square me-2"></i>Wydatki
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-white py-2 rounded {% block menu_incomes %}{% endblock %}" href="#"
                       id="incomes-link"
                       onclick="navigateToIncomes()">
                        <i class="bi bi-arrow-right-square me-2"></i>Przychody
                    </a>
                </li>
            </ul>
            <hr class="border-secondary">
            <h4 class="fw-bold pb-2 mb-3">Filtry</h4>
            <form action="{% url 'filtered-transactions' %}" method="GET">
                <div class="mb-2 text-light-emphasis small">Kategoria</div>
                <select class="form-select form-select-sm bg-secondary-subtle text-dark border-secondary-subtle mb-3" id="category-filter"
                        name="category">
                    <option value="">Wszystkie kategorie</option>
                    {% for category in categories %}
                    <option value="{{ category }}" {% if selected_category == category %}selected{% endif %}>{{ category }}</option>
                    {% endfor %}
                </select>
                <div class="mb-2">
                    <label class="form-label text-light-emphasis small mb-1" for="date-from">Transakcje od</label>
                    <div class="date-input-group">
                        <input autocomplete="off" class="form-control form-control-sm bg-secondary-subtle text-dark border-secondary-subtle" id="date-from"
                               name="date_from"
                               placeholder="RRRR-MM-DD" type="text" value="{{ date_from }}">
                        <i class="bi bi-calendar3 calendar-icon" id="calendar-from-icon"></i>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label text-light-emphasis small mb-1" for="date-to">Transakcje do</label>
                    <div class="date-input-group">
                        <input autocomplete="off" class="form-control form-control-sm bg-secondary-subtle text-dark border-secondary-subtle" id="date-to"
                               name="date_to"
                               placeholder="RRRR-MM-DD" type="text" value="{{ date_to }}">
                        <i class="bi bi-calendar3 calendar-icon" id="calendar-to-icon"></i>
                    </div>
                </div>
                <button class="btn btn-sm btn-primary w-100" type="submit" onclick="closeMobileSidebar()">Zastosuj filtry</button>
            </form>
        </div>

        <!-- Main Content -->
        <div class="col-lg-10 p-0 main-content">
            <div class="bg-light p-4 shadow-sm mobile-header">
                <div class="d-flex justify-content-between align-items-center flex-column flex-md-row">
                    <h2 class="mb-0">{% block header_title %}Transakcje użytkownika{% endblock %}</h2>

                    <!-- Switch do przełączania widoku transakcji -->
                    <div class="switch-container mt-2 mt-md-0">
                        <span class="switch-label text-muted">
                            <i class="bi bi-person me-1"></i>Moje
                        </span>
                        <div class="switch-wrapper">
                            <div class="form-check form-switch"
                                 data-bs-placement="top"
                                 data-bs-toggle="tooltip"
                                 title="Przełącz między widokiem twoich transakcji, a całej Twojej rodziny.">
                                <input class="form-check-input" id="viewToggleSwitch" onchange="toggleTransactionView()" role="switch"
                                       type="checkbox">
                            </div>
                        </div>
                        <span class="switch-label text-muted">
                            <i class="bi bi-people me-1"></i>Rodzina
                        </span>
                    </div>
                </div>
            </div>
            <div class="container-fluid p-4 mobile-content">
                {% block content %}{% endblock %}
            </div>
        </div>
    </div>
</div>

<!-- jQuery (wymagany przez Bootstrap Datepicker - kalendarz) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Bootstrap JS Bundle z Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Bootstrap Datepicker JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
<!-- Bootstrap Datepicker PL Lokalizacja -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/locales/bootstrap-datepicker.pl.min.js"></script>

<script>
    // Mobile sidebar functions
    function toggleMobileSidebar() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.querySelector('.sidebar-overlay');

        sidebar.classList.toggle('show');
        overlay.classList.toggle('show');

        // Prevent body scroll when sidebar is open
        if (sidebar.classList.contains('show')) {
            document.body.style.overflow = 'hidden';
        } else {
            document.body.style.overflow = '';
        }
    }

    function closeMobileSidebar() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.querySelector('.sidebar-overlay');

        sidebar.classList.remove('show');
        overlay.classList.remove('show');
        document.body.style.overflow = '';
    }

    // Close sidebar when clicking on navigation links on mobile
    document.addEventListener('DOMContentLoaded', function() {
        const navLinks = document.querySelectorAll('.sidebar .nav-link');
        navLinks.forEach(link => {
            link.addEventListener('click', function() {
                if (window.innerWidth < 992) {
                    setTimeout(closeMobileSidebar, 100);
                }
            });
        });
    });

    $(document).ready(function () {
        var datepickerOptions = {
            format: 'yyyy-mm-dd',
            todayBtn: 'linked',
            clearBtn: false,
            language: 'pl',
            autoclose: true,
            todayHighlight: true,
            zIndexOffset: 1000
        };

        // Inicjalizacja datepickerów
        $('#date-from, #date-to').datepicker(datepickerOptions);

        // Obsługa kliknięcia ikon kalendarza
        $('#calendar-from-icon').click(function () {
            $('#date-from').datepicker('show');
        });
        $('#calendar-to-icon').click(function () {
            $('#date-to').datepicker('show');
        });

        // Inicjalizacja tooltipów Bootstrap
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });
    });

    // Funkcja do nawigacji do strony "Wydatki"
    function navigateToExpenses() {
        const toggle = document.getElementById('viewToggleSwitch');
        if (toggle.checked) {
            window.location.href = '/transactions/family/filter/?type=expense';
        } else {
            window.location.href = '/transactions/filter/?type=expense';
        }
    }

    // Funkcja do nawigacji do strony "Przychody"
    function navigateToIncomes() {
        const toggle = document.getElementById('viewToggleSwitch');
        if (toggle.checked) {
            window.location.href = '/transactions/family/filter/?type=income';
        } else {
            window.location.href = '/transactions/filter/?type=income';
        }
    }

    // Funkcja do przełączania widoku transakcji
    function toggleTransactionView() {
        const toggle = document.getElementById('viewToggleSwitch');
        const currentPath = window.location.pathname;
        const currentSearch = window.location.search;

        if (toggle.checked) {
            // Przełącz na widok rodzinny
            if (currentPath === '/transactions/filter/') {
                window.location.href = '/transactions/family/filter/' + currentSearch;
            } else {
                window.location.href = '/transactions/family/filter/';
            }
        } else {
            // Przełącz na widok osobisty
            if (currentPath === '/transactions/family/filter/') {
                window.location.href = '/transactions/filter/' + currentSearch;
            } else {
                window.location.href = '/transactions/filter/';
            }
        }

        updateAllTransactionsLink();
    }

    // Funkcja do nawigacji do strony "Wszystkie transakcje"
    function navigateToAllTransactions() {
        const toggle = document.getElementById('viewToggleSwitch');
        if (toggle.checked) {
            window.location.href = '/transactions/family/filter/';
        } else {
            window.location.href = '/transactions/filter/';
        }
    }

    // Funkcja do aktualizacji linku "Wszystkie"
    function updateAllTransactionsLink() {
        const toggle = document.getElementById('viewToggleSwitch');
        const allTransactionsLink = document.getElementById('all-transactions-link');

        if (toggle.checked) {
            allTransactionsLink.setAttribute('data-target', '/transactions/family/filter/');
        } else {
            allTransactionsLink.setAttribute('data-target', '/transactions/filter/');
        }
    }

    // Ustawienie stanu switch'a na podstawie aktualnej ścieżki URL
    document.addEventListener('DOMContentLoaded', function () {
        const toggle = document.getElementById('viewToggleSwitch');
        const currentPath = window.location.pathname;
        if (currentPath.includes('/transactions/family/') ||
            currentPath.includes('/expenses/family/') ||
            currentPath.includes('/incomes/family/')) {
            toggle.checked = true;
        } else {
            toggle.checked = false;
        }
        updateAllTransactionsLink();
    });
</script>
{% block extra_scripts %}{% endblock %}
</body>
</html>