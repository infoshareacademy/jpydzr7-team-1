{% extends 'base.html' %}
{% block title %}Wydatki rodziny{% endblock %}
{% block menu_family %}active{% endblock %}
{% block header_title %}Wydatki całej rodziny{% endblock %}
{% block content %}
    {% if transactions %}
        <table id="transactionsTable" class="table table-hover">
            <thead class="table-dark fw-bold">
                <tr>
                    <th>ID</th>
                    <th>Data</th>
                    <th>Użytkownik</th>
                    <th>Kwota</th>
                    <th>Opis</th>
                    <th>Kategoria</th>
                </tr>
            </thead>
            <tbody>
                {% for transaction in transactions %}
                    <tr>
                        <td>{{ transaction.transaction_id }}</td>
                        <td>{{ transaction.transaction_date|date:"d.m.Y" }}</td>
                        <td>
                        {% if transaction.user_name %}
                            <span class="fw-bold">
                                {{ transaction.user_name }}
                            </span>
                            {% if transaction.user_role%}
                                {% if transaction.user_role == 'kid' %}
                                    <small class="text-muted d-block">(dziecko)</small>
                                {% endif %}
                            {% endif %}
                        {% else %}
                            <span class="text-muted">Nieznany użytkownik</span>
                        {% endif %}
                        </td>
                        <td class="text-danger">{{ transaction.expense|floatformat:2 }} zł</td>
                        <td>{{ transaction.description|default:"-" }}</td>
                        <td>{{ transaction.category|default:"-" }}</td>
                    </tr>
                {% endfor %}
                <tr class="table-secondary fw-bold">
                    <td colspan="3">Suma wydatków rodziny:</td>
                    <td class="text-danger">{{ total_expense|floatformat:2 }} zł</td>
                    <td colspan="2"></td>
                </tr>
            </tbody>
        </table>

        <!-- Podsumowanie według członków rodziny -->
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">Wydatki poszczególnych członków</h5>
                    </div>
                    <div class="card-body">
                        {% if family_expenses %}
                            {% for member_expense in family_expenses %}
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span>
                                        <strong>{{ member_expense.user_name }} {{ member_expense.user_surname }}</strong>
                                        {% if member_expense.user_role == 'kid' %}
                                            <small class="text-muted"><i class="bi bi-person-hearts"></i></small>
                                        {% endif %}
                                    </span>
                                    <span class="text-danger fw-bold">
                                        {{ member_expense.total_expense|floatformat:2 }} zł
                                    </span>
                                </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted mb-0">Brak informacji o wydatkach członków rodziny</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtrowanie po kategorii -->
        {% if categories %}
        <div class="mt-4">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Filtruj po kategorii</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-12">
                            <a href="?" class="btn btn-outline-secondary btn-sm me-2 mb-2 {% if not selected_category %}active{% endif %}">
                                Wszystkie
                            </a>
                            {% for category in categories %}
                                <a href="?category={{ category }}" class="btn btn-outline-primary btn-sm me-2 mb-2 {% if selected_category == category %}active{% endif %}">
                                    {{ category }}
                                </a>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Filtrowanie po członkach rodziny -->
        {% if family_members %}
        <div class="mt-4">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Filtruj po członkach rodziny</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-12">
                            <a href="?" class="btn btn-outline-secondary btn-sm me-2 mb-2 {% if not selected_user %}active{% endif %}">
                                Wszyscy
                            </a>
                            {% for member in family_members %}
                                <a href="?user={{ member.user_id }}" class="btn btn-outline-success btn-sm me-2 mb-2 {% if selected_user == member.user_id|stringformat:'s' %}active{% endif %}">
                                    {{ member.name }} {{ member.surname }}
                                    {% if member.role == 'kid' %} (dziecko){% endif %}
                                </a>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

    {% else %}
        <div class="alert alert-info">
            <h4 class="alert-heading">Brak wydatków</h4>
            <p class="mb-0">Nie znaleziono żadnych wydatków dla rodziny.</p>
        </div>
    {% endif %}
{% endblock %}